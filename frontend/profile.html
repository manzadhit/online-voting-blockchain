<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlockVote - Profile</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        padding: 0;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #2563eb;
      }

      nav ul {
        display: flex;
        list-style: none;
      }

      nav ul li {
        margin-left: 20px;
      }

      nav ul li a {
        text-decoration: none;
        color: #4b5563;
        font-weight: 500;
        transition: color 0.3s;
      }

      nav ul li a:hover {
        color: #2563eb;
      }

      nav ul li a.active {
        color: #2563eb;
        font-weight: 600;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      .profile-section {
        padding: 40px 0;
        min-height: calc(100vh - 200px);
      }

      .profile-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .profile-header h1 {
        font-size: 2.5rem;
        color: #1e40af;
        margin-bottom: 10px;
      }

      .profile-header p {
        color: #64748b;
        font-size: 1.1rem;
      }

      .profile-container {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 30px;
        max-width: 1000px;
        margin: 0 auto;
      }

      .profile-card {
        background-color: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: fit-content;
      }

      .profile-avatar {
        text-align: center;
        margin-bottom: 30px;
      }

      .avatar-circle {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        color: white;
        font-size: 3rem;
        font-weight: bold;
      }

      .profile-info h2 {
        color: #1e3a8a;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .info-item {
        margin-bottom: 15px;
        padding: 10px 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .info-label {
        font-weight: 600;
        color: #475569;
        font-size: 0.9rem;
        margin-bottom: 5px;
      }

      .info-value {
        color: #1e293b;
        font-size: 1rem;
      }

      .wallet-status {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .wallet-connected {
        background-color: #dcfce7;
        color: #166534;
      }

      .wallet-not-connected {
        background-color: #fef2f2;
        color: #dc2626;
      }

      .form-section {
        background-color: #fff;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .form-section h2 {
        color: #1e3a8a;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #374151;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s, box-shadow 0.3s;
      }

      .form-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .form-input:disabled {
        background-color: #f9fafb;
        color: #6b7280;
        cursor: not-allowed;
      }

      .form-textarea {
        resize: vertical;
        min-height: 80px;
      }

      .btn {
        display: inline-block;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1rem;
      }

      .btn-primary {
        background-color: #2563eb;
        color: white;
      }

      .btn-primary:hover {
        background-color: #1d4ed8;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }

      .btn-secondary {
        background-color: #6b7280;
        color: white;
      }

      .btn-secondary:hover {
        background-color: #4b5563;
      }

      .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
      }

      .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 0.9rem;
      }

      .alert-success {
        background-color: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }

      .alert-error {
        background-color: #fef2f2;
        color: #dc2626;
        border: 1px solid #fecaca;
      }

      .alert-warning {
        background-color: #fef3c7;
        color: #d97706;
        border: 1px solid #fde68a;
      }

      .wallet-info {
        background-color: #f0f9ff;
        border: 1px solid #bfdbfe;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
      }

      .wallet-info h3 {
        color: #1e40af;
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .wallet-info p {
        color: #1e3a8a;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      footer {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 40px 0;
        margin-top: 60px;
      }

      .footer-content {
        text-align: center;
      }

      .footer-logo {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 15px;
      }

      .footer-content p {
        color: #94a3b8;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .profile-container {
          grid-template-columns: 1fr;
          gap: 20px;
        }

        .profile-header h1 {
          font-size: 2rem;
        }

        .btn-group {
          flex-direction: column;
        }

        nav ul {
          flex-direction: column;
          gap: 10px;
        }

        nav ul li {
          margin-left: 0;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">BlockVote</div>
      <nav>
        <ul>
          <li><a href="beranda.html">Beranda</a></li>
          <li><a href="profile.html" class="active">Profile</a></li>
          <li><a href="voting.html">Vote Now</a></li>
          <li><a href="result.html">Hasil Voting</a></li>
          <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </nav>
    </header>

    <section class="profile-section">
      <div class="container">
        <div class="profile-header">
          <h1>Profile Pemilih</h1>
          <p>
            Kelola informasi profile dan wallet address untuk sistem voting
            blockchain
          </p>
        </div>

        <div class="profile-container">
          <!-- Profile Info Card -->
          <div class="profile-card">
            <div class="profile-avatar">
              <div class="avatar-circle" id="avatarCircle">
                <!-- Initial akan diisi dengan JavaScript -->
              </div>
              <h3 id="profileName">-</h3>
            </div>

            <div class="profile-info">
              <h2>Informasi Pemilih</h2>

              <div class="info-item">
                <div class="info-label">NIM</div>
                <div class="info-value" id="profileNim">-</div>
              </div>

              <div class="info-item">
                <div class="info-label">Fakultas</div>
                <div class="info-value" id="profileFaculty">-</div>
              </div>

              <div class="info-item">
                <div class="info-label">Status Wallet</div>
                <div class="info-value">
                  <span
                    class="wallet-status wallet-not-connected"
                    id="walletStatus"
                  >
                    Belum Terhubung
                  </span>
                </div>
              </div>

              <div class="info-item">
                <div class="info-label">Terdaftar Sejak</div>
                <div class="info-value" id="profileCreatedAt">-</div>
              </div>
            </div>
          </div>

          <!-- Profile Form -->
          <div class="form-section">
            <h2>Pengaturan Profile</h2>

            <div id="alertContainer"></div>

            <form id="profileForm">
              <div class="form-group">
                <label class="form-label" for="name">Nama Lengkap</label>
                <input type="text" id="name" class="form-input" disabled />
              </div>

              <div class="form-group">
                <label class="form-label" for="nim">NIM</label>
                <input type="text" id="nim" class="form-input" disabled />
              </div>

              <div class="form-group">
                <label class="form-label" for="faculty">Fakultas</label>
                <input type="text" id="faculty" class="form-input" disabled />
              </div>

              <div class="wallet-info">
                <h3>🔐 Wallet Address untuk Blockchain</h3>
                <p>
                  Wallet address diperlukan untuk berpartisipasi dalam sistem
                  voting blockchain. Pastikan address yang dimasukkan valid dan
                  dapat diakses oleh Anda.
                </p>
              </div>

              <div class="form-group">
                <label class="form-label" for="walletAddress">
                  Wallet Address *
                  <span style="color: #dc2626; font-size: 0.8rem"
                    >(Required untuk voting)</span
                  >
                </label>
                <input
                  type="text"
                  id="walletAddress"
                  class="form-input"
                  placeholder="0x1234567890abcdef1234567890abcdef12345678"
                  maxlength="42"
                />
                <small style="color: #6b7280; font-size: 0.8rem">
                  Format: 0x diikuti 40 karakter hexadecimal
                </small>
              </div>

              <div class="form-group">
                <label class="form-label" for="currentPassword"
                  >Password Saat Ini</label
                >
                <input
                  type="password"
                  id="currentPassword"
                  class="form-input"
                  placeholder="Masukkan password saat ini"
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="newPassword"
                  >Password Baru (Opsional)</label
                >
                <input
                  type="password"
                  id="newPassword"
                  class="form-input"
                  placeholder="Masukkan password baru"
                />
              </div>

              <div class="form-group">
                <label class="form-label" for="confirmPassword"
                  >Konfirmasi Password Baru</label
                >
                <input
                  type="password"
                  id="confirmPassword"
                  class="form-input"
                  placeholder="Konfirmasi password baru"
                />
              </div>

              <div class="btn-group">
                <button type="submit" class="btn btn-primary">
                  Simpan Perubahan
                </button>
                <button type="button" class="btn btn-secondary" id="resetBtn">
                  Reset Form
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-logo">BlockVote</div>
          <p>&copy; 2025 BlockVote. Hak Cipta Dilindungi.</p>
        </div>
      </div>
    </footer>

    <script>
      // Gunakan $(document).ready() sebagai pengganti DOMContentLoaded
      $(document).ready(function () {
        // --- Inisialisasi ---
        const currentUser = JSON.parse(localStorage.getItem("userData"));

        // Jika tidak ada data user, alihkan ke halaman login
        if (!currentUser) {
          window.location.href = "login.html";
          return;
        }

        // Fungsi utama untuk memuat halaman
        function initializePage() {
          loadUserData();
          setupEventListeners();
        }

        // --- Fungsi Logika ---

        function loadUserData() {
          // Update profile info dengan jQuery
          $("#profileName").text(currentUser.name);
          $("#profileNim").text(currentUser.nim);
          $("#profileFaculty").text(currentUser.faculty);
          $("#profileCreatedAt").text(formatDate(currentUser.createdAt));

          // Update avatar
          const initials = currentUser.name
            .split(" ")
            .map((n) => n[0])
            .join("")
            .toUpperCase();
          $("#avatarCircle").text(initials);

          // Update status dompet
          updateWalletStatus();

          // Isi nilai form
          $("#name").val(currentUser.name);
          $("#nim").val(currentUser.nim);
          $("#faculty").val(currentUser.faculty);
          $("#walletAddress").val(currentUser.walletAddress || "");

          // Disable wallet address input jika sudah ada dan valid
          checkAndDisableWalletInput();
        }

        function updateWalletStatus() {
          if (
            currentUser.walletAddress &&
            isValidWalletAddress(currentUser.walletAddress)
          ) {
            $("#walletStatus")
              .text("Terhubung")
              .removeClass("wallet-not-connected")
              .addClass("wallet-connected");
          } else {
            $("#walletStatus")
              .text("Belum Terhubung")
              .removeClass("wallet-connected")
              .addClass("wallet-not-connected");
          }
        }

        // Fungsi baru untuk mengecek dan disable wallet input
        function checkAndDisableWalletInput() {
          if (
            currentUser.walletAddress &&
            isValidWalletAddress(currentUser.walletAddress)
          ) {
            $("#walletAddress").prop("disabled", true).css({
              backgroundColor: "#f3f4f6",
              cursor: "not-allowed",
              opacity: "0.7",
            });

            // Tambahkan informasi bahwa wallet sudah terhubung
            if (!$("#walletConnectedInfo").length) {
              $("#walletAddress").after(
                '<small id="walletConnectedInfo" class="text-success mt-1 d-block">✓ Alamat dompet sudah terhubung dan tidak dapat diubah</small>'
              );
            }
          } else {
            $("#walletAddress").prop("disabled", false).css({
              backgroundColor: "",
              cursor: "",
              opacity: "",
            });

            // Hapus informasi jika ada
            $("#walletConnectedInfo").remove();
          }
        }

        function isValidWalletAddress(address) {
          return /^0x[a-fA-F0-9]{40}$/.test(address);
        }

        function showAlert(message, type = "success") {
          // Membuat elemen dengan jQuery
          const alertDiv = $("<div></div>")
            .addClass(`alert alert-${type}`)
            .text(message);

          // Menampilkan alert dan menghapusnya setelah 5 detik dengan efek fade
          $("#alertContainer").empty().append(alertDiv);
          setTimeout(() => {
            alertDiv.fadeOut(500, function () {
              $(this).remove();
            });
          }, 5000);
        }

        function formatDate(dateString) {
          return new Date(dateString).toLocaleDateString("id-ID", {
            year: "numeric",
            month: "long",
            day: "numeric",
          });
        }

        // --- Event Listeners dengan jQuery ---

        function setupEventListeners() {
          $("#profileForm").on("submit", handleProfileSubmit);
          $("#resetBtn").on("click", handleReset);
          $("#logoutBtn").on("click", handleLogout);
          $("#walletAddress").on("input", validateWalletAddressInput);
          $("#confirmPassword").on("input", validatePasswordConfirmation);
        }

        function handleProfileSubmit(e) {
          e.preventDefault();

          // Cek apakah wallet address sudah terhubung
          if (
            currentUser.walletAddress &&
            isValidWalletAddress(currentUser.walletAddress)
          ) {
            showAlert(
              "Alamat dompet sudah terhubung dan tidak dapat diubah!",
              "warning"
            );
            return;
          }

          // Mengambil nilai form dengan .val()
          const walletAddress = $("#walletAddress").val().trim();
          const currentPassword = $("#currentPassword").val();
          const newPassword = $("#newPassword").val();

          // Validasi wallet address sebelum submit
          if (!walletAddress) {
            showAlert("Alamat dompet tidak boleh kosong!", "error");
            return;
          }

          if (!isValidWalletAddress(walletAddress)) {
            showAlert("Format alamat dompet tidak valid!", "error");
            return;
          }

          // Panggil fungsi untuk update, sekarang dengan AJAX
          updateProfile(walletAddress, currentPassword, newPassword);
        }

        // --- Fungsi AJAX ---

        function updateProfile(walletAddress, currentPassword, newPassword) {
          const submitBtn = $('#profileForm button[type="submit"]');
          const originalText = submitBtn.text();
          submitBtn.text("Menyimpan...").prop("disabled", true);

          // Kirim data ke API back-end Anda
          $.ajax({
            url: "http://localhost:3000/students/addWalletAddress",
            method: "POST", // atau 'PUT' tergantung desain API Anda
            contentType: "application/json",
            data: JSON.stringify({
              nim: currentUser.nim,
              walletAddress: walletAddress,
              // Anda mungkin perlu mengirim password juga untuk verifikasi di back-end
            }),
            success: function (response) {
              showAlert(
                "Alamat dompet berhasil diperbarui dan terhubung!",
                "success"
              );

              // Update data currentUser di localStorage jika berhasil
              currentUser.walletAddress = walletAddress;
              localStorage.setItem("userData", JSON.stringify(currentUser));

              // Perbarui tampilan UI
              updateWalletStatus();

              // Disable wallet input setelah berhasil
              checkAndDisableWalletInput();
            },
            error: function (xhr) {
              const errorMessage =
                xhr.responseJSON?.message ||
                "Terjadi kesalahan. Silakan coba lagi.";
              showAlert(errorMessage, "error");
            },
            complete: function () {
              // Kembalikan tombol ke keadaan semula baik sukses maupun gagal
              submitBtn.text(originalText).prop("disabled", false);
              // Kosongkan field password
              $("#currentPassword, #newPassword, #confirmPassword").val("");
            },
          });
        }

        // --- Fungsi Validasi Input ---

        function validateWalletAddressInput() {
          // Jangan validasi jika input sudah disabled
          if ($(this).prop("disabled")) {
            return;
          }

          const address = $(this).val().trim();
          if (address && !isValidWalletAddress(address)) {
            $(this).css("borderColor", "#dc2626");
          } else {
            $(this).css("borderColor", "#e5e7eb");
          }
        }

        function validatePasswordConfirmation() {
          const newPass = $("#newPassword").val();
          const confirmPass = $(this).val();
          if (confirmPass && newPass !== confirmPass) {
            $(this).css("borderColor", "#dc2626");
          } else {
            $(this).css("borderColor", "#e5e7eb");
          }
        }

        // --- Fungsi Tombol Lainnya ---

        function handleReset() {
          if (confirm("Apakah Anda yakin ingin mereset form?")) {
            loadUserData();
            $("#currentPassword, #newPassword, #confirmPassword").val("");
            $("#alertContainer").empty();
          }
        }

        function handleLogout(e) {
          e.preventDefault();
          if (confirm("Apakah Anda yakin ingin logout?")) {
            showAlert("Logout berhasil. Mengalihkan...", "success");
            setTimeout(() => {
              window.location.href = "login.html";
            }, 1500);
          }
        }

        // Panggil fungsi inisialisasi
        initializePage();
      });
    </script>
  </body>
</html>
