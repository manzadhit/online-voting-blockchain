<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BlockVote - Admin Panel</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        padding: 0;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #2563eb;
      }

      nav ul {
        display: flex;
        list-style: none;
      }

      nav ul li {
        margin-left: 20px;
      }

      nav ul li a {
        text-decoration: none;
        color: #4b5563;
        font-weight: 500;
        transition: color 0.3s;
      }

      nav ul li a:hover {
        color: #2563eb;
      }

      nav ul li a.active {
        color: #2563eb;
        font-weight: 600;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .admin-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }

      .admin-title {
        font-size: 28px;
        color: #1e40af;
      }

      .admin-tabs {
        display: flex;
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 30px;
      }

      .admin-tab {
        padding: 12px 24px;
        cursor: pointer;
        font-weight: 500;
        color: #64748b;
        border-bottom: 2px solid transparent;
        transition: all 0.3s;
      }

      .admin-tab.active {
        color: #2563eb;
        border-bottom: 2px solid #2563eb;
      }

      .admin-tab:hover {
        color: #2563eb;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .card {
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        padding: 30px;
        margin-bottom: 30px;
      }

      .card-title {
        font-size: 20px;
        margin-bottom: 20px;
        color: #1e3a8a;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 10px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #4b5563;
      }

      .form-input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 16px;
        transition: border-color 0.3s;
      }

      .form-input:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      .input-row {
        display: flex;
        gap: 20px;
      }

      .input-row .form-group {
        flex: 1;
      }

      textarea.form-input {
        resize: vertical;
        min-height: 100px;
      }

      .form-select {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 16px;
        background-color: white;
        transition: border-color 0.3s;
      }

      .btn {
        display: inline-block;
        padding: 12px 30px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none;
        transition: transform 0.3s, box-shadow 0.3s;
        cursor: pointer;
        border: none;
        font-size: 16px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .btn-primary {
        background-color: #2563eb;
        color: white;
      }

      .btn-secondary {
        background-color: #e5e7eb;
        color: #4b5563;
      }

      .btn-success {
        background-color: #10b981;
        color: white;
      }

      .table-container {
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }

      th {
        background-color: #f9fafb;
        color: #4b5563;
        font-weight: 600;
      }

      tr:hover {
        background-color: #f9fafb;
      }

      .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .badge-success {
        background-color: #d1fae5;
        color: #065f46;
      }

      .badge-secondary {
        background-color: #e5e7eb;
        color: #4b5563;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
      }

      .btn-small {
        padding: 6px 12px;
        font-size: 14px;
      }

      .btn-edit {
        background-color: #f59e0b;
        color: white;
      }

      .btn-delete {
        background-color: #ef4444;
        color: white;
      }

      .btn-view {
        background-color: #3b82f6;
        color: white;
      }

      .response-message {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .success-message {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }

      .error-message {
        background-color: #fee2e2;
        color: #b91c1c;
        border: 1px solid #fecaca;
      }

      footer {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 40px 0;
        margin-top: 60px;
      }

      .footer-content {
        display: flex;
        justify-content: space-between;
      }

      .footer-info {
        width: 30%;
      }

      .footer-logo {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 15px;
      }

      .footer-info p {
        color: #94a3b8;
        line-height: 1.6;
        font-size: 0.9rem;
        margin-bottom: 20px;
      }

      .footer-bottom {
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid #334155;
        text-align: center;
        color: #64748b;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .input-row {
          flex-direction: column;
          gap: 0;
        }

        .footer-content {
          flex-direction: column;
        }

        .footer-info {
          width: 100%;
          margin-bottom: 30px;
        }
      }

      /* Styles untuk manajemen peer */
      .connected-peers-summary {
        background-color: #f5f8ff;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .peer-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 10px;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 20px;
        background-color: white;
        border-radius: 6px;
        min-width: 120px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #2c5282;
      }

      .stat-label {
        font-size: 14px;
        color: #4a5568;
        margin-top: 5px;
      }

      #add-peer-form {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: flex-end;
        margin-bottom: 15px;
      }

      #add-peer-form .form-group {
        flex: 1;
        min-width: 250px;
      }

      @media (max-width: 768px) {
        #add-peer-form {
          flex-direction: column;
          gap: 15px;
        }

        #add-peer-form button {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="logo">BlockVote</div>
      <nav>
        <ul>
          <li><a href="beranda.html">Beranda</a></li>
          <li><a href="blockchain-explorer.html">Blockchain Explorer</a></li>
          <li><a href="result.html">Hasil Voting</a></li>
          <li><a href="#" id="logoutBtn">Logout</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <div class="admin-header">
        <h1 class="admin-title">Panel Admin</h1>
      </div>

      <div class="admin-tabs">
        <div class="admin-tab active" data-tab="candidates">Kandidat</div>
        <div class="admin-tab" data-tab="elections">Pemilihan</div>
        <div class="admin-tab" data-tab="students">Mahasiswa</div>
        <div class="admin-tab" data-tab="peers">Manajemen Peer</div>
      </div>

      <!-- Candidates Tab -->
      <div id="candidates-tab" class="tab-content active">
        <div class="card">
          <h2 class="card-title">Tambah Kandidat Baru</h2>
          <div id="candidate-response" class="response-message"></div>
          <form id="add-candidate-form">
            <div class="input-row">
              <div class="form-group">
                <label class="form-label">Nama Kandidat Utama</label>
                <input
                  type="text"
                  class="form-input"
                  id="mainName"
                  placeholder="Masukkan nama kandidat utama"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Inisial Kandidat Utama</label>
                <input
                  type="text"
                  class="form-input"
                  id="mainInitials"
                  placeholder="Contoh: DK"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Fakultas Kandidat Utama</label>
                <input
                  type="text"
                  class="form-input"
                  id="mainFaculty"
                  placeholder="Contoh: Fakultas Kedokteran"
                />
              </div>
            </div>
            <div class="input-row">
              <div class="form-group">
                <label class="form-label">Nama Wakil Kandidat</label>
                <input
                  type="text"
                  class="form-input"
                  id="deputyName"
                  placeholder="Masukkan nama wakil kandidat"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Inisial Wakil Kandidat</label>
                <input
                  type="text"
                  class="form-input"
                  id="deputyInitials"
                  placeholder="Contoh: RH"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Fakultas Wakil Kandidat</label>
                <input
                  type="text"
                  class="form-input"
                  id="deputyFaculty"
                  placeholder="Contoh: Fakultas Ilmu Komputer"
                />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Visi</label>
              <textarea
                class="form-input"
                id="vision"
                placeholder="Masukkan visi kandidat"
              ></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Pemilihan</label>
              <select class="form-select" id="electionId"></select>
            </div>
            <button type="submit" class="btn btn-primary">
              Tambah Kandidat
            </button>
          </form>
        </div>

        <div class="card">
          <h2 class="card-title">Daftar Kandidat</h2>
          <div class="table-container">
            <table id="candidates-table">
              <thead>
                <tr>
                  <th>Nama Kandidat</th>
                  <th>Wakil Kandidat</th>
                  <th>Pemilihan</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Elections Tab -->
      <div id="elections-tab" class="tab-content">
        <div class="card">
          <h2 class="card-title">Tambah Pemilihan Baru</h2>
          <div id="election-response" class="response-message"></div>
          <form id="add-election-form">
            <div class="form-group">
              <label class="form-label">Nama Pemilihan</label>
              <input
                type="text"
                class="form-input"
                id="electionName"
                placeholder="Contoh: Pemilihan Ketua BEM"
              />
            </div>
            <div class="input-row">
              <div class="form-group">
                <label class="form-label">Tanggal Mulai</label>
                <input
                  type="datetime-local"
                  class="form-input"
                  id="startDate"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Tanggal Selesai</label>
                <input type="datetime-local" class="form-input" id="endDate" />
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Status</label>
              <select class="form-select" id="isActive">
                <option value="true">Aktif</option>
                <option value="false">Tidak Aktif</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">
              Tambah Pemilihan
            </button>
          </form>
        </div>

        <div class="card">
          <h2 class="card-title">Daftar Pemilihan</h2>
          <div class="table-container">
            <table id="elections-table">
              <thead>
                <tr>
                  <th>Nama Pemilihan</th>
                  <th>Tanggal Mulai</th>
                  <th>Tanggal Selesai</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Pemilihan Ketua BEM</td>
                  <td>10 April 2025, 08:00</td>
                  <td>15 April 2025, 17:00</td>
                  <td><span class="badge badge-success">Aktif</span></td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-small btn-edit">Edit</button>
                      <button class="btn btn-small btn-delete">Hapus</button>
                    </div>
                  </td>
                </tr>
                <tr>
                  <td>Pemilihan Ketua DPM</td>
                  <td>20 April 2025, 08:00</td>
                  <td>25 April 2025, 17:00</td>
                  <td>
                    <span class="badge badge-secondary">Tidak Aktif</span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-small btn-edit">Edit</button>
                      <button class="btn btn-small btn-delete">Hapus</button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Students Tab -->
      <div id="students-tab" class="tab-content">
        <div class="card">
          <h2 class="card-title">Tambah Mahasiswa Baru</h2>
          <div id="student-response" class="response-message"></div>
          <form id="add-student-form">
            <div class="input-row">
              <div class="form-group">
                <label class="form-label">NIM</label>
                <input
                  type="text"
                  class="form-input"
                  id="nim"
                  placeholder="Contoh: E1E123001"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Nama</label>
                <input
                  type="text"
                  class="form-input"
                  id="nama"
                  placeholder="Masukkan nama lengkap"
                />
              </div>
            </div>
            <div class="input-row">
              <div class="form-group">
                <label class="form-label">Fakultas</label>
                <input
                  type="text"
                  class="form-input"
                  id="faculty"
                  placeholder="Contoh: Teknik"
                />
              </div>
              <div class="form-group">
                <label class="form-label">Password</label>
                <input
                  type="password"
                  class="form-input"
                  id="password"
                  placeholder="Masukkan password"
                />
              </div>
            </div>
            <button type="submit" class="btn btn-primary">
              Tambah Mahasiswa
            </button>
          </form>
        </div>

        <div class="card">
          <h2 class="card-title">Daftar Mahasiswa</h2>
          <div class="table-container">
            <table id="students-table">
              <thead>
                <tr>
                  <th>NIM</th>
                  <th>Nama</th>
                  <th>Fakultas</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="peers-tab" class="tab-content">
        <div class="dashboard-card">
          <h2>Manajemen Peer/Node</h2>
          <div class="connected-peers-summary">
            <h3>Status Koneksi</h3>
            <div class="peer-stats">
              <div class="stat-item">
                <div class="stat-value" id="total-peers">0</div>
                <div class="stat-label">Peer Terhubung</div>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Tambah Peer Baru</h3>
            <form id="add-peer-form">
              <div class="form-group">
                <label for="peerAddress">Alamat Peer:</label>
                <input
                  type="text"
                  id="peerAddress"
                  name="peerAddress"
                  required
                  placeholder="192.168.1.100:3000"
                />
              </div>
              <button type="submit" class="btn btn-primary">
                Hubungkan ke Peer
              </button>
            </form>
            <div id="peer-response" class="response-message"></div>
          </div>

          <div class="section">
            <h3>Daftar Peer yang Terhubung</h3>
            <div class="table-container">
              <table id="peers-table" class="data-table">
                <thead>
                  <tr>
                    <th>Alamat Peer</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data peers akan ditampilkan di sini -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="container">
        <div class="footer-content">
          <div class="footer-info">
            <div class="footer-logo">BlockVote</div>
            <p>
              Sistem voting online berbasis blockchain yang menggabungkan
              keamanan kriptografi dengan transparansi blockchain untuk
              memastikan integritas proses voting digital.
            </p>
          </div>
        </div>
        <div class="footer-bottom">
          <p>&copy; 2025 BlockVote. Hak Cipta Dilindungi.</p>
        </div>
      </div>
    </footer>

    <!-- jQuery library -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="./login.js"></script>
    <script>
      const tabs = document.querySelectorAll(".admin-tab");
      const tabContents = document.querySelectorAll(".tab-content");

      tabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          // Remove active class from all tabs
          tabs.forEach((t) => t.classList.remove("active"));
          tabContents.forEach((content) => content.classList.remove("active"));

          // Add active class to clicked tab
          tab.classList.add("active");

          // Show corresponding content
          const tabId = tab.getAttribute("data-tab");
          document.getElementById(`${tabId}-tab`).classList.add("active");
        });
      });
      // Function to display response message
      function showMessage(elementId, message, isSuccess) {
        const responseDiv = document.getElementById(elementId);
        responseDiv.textContent = message;
        responseDiv.className = isSuccess
          ? "response-message success-message"
          : "response-message error-message";
        responseDiv.style.display = "block";

        // Hide message after 5 seconds
        setTimeout(() => {
          responseDiv.style.display = "none";
        }, 5000);
      }

      // Fungsi untuk memuat daftar peer
      async function loadPeers() {
        try {
          const response = await fetch("http://localhost:3000/peers");
          const result = await response.json();

          if (!response.ok) {
            throw new Error("Failed to fetch peers");
          }

          // Update jumlah peer terhubung
          $("#total-peers").text(result.peers.length);

          // Kosongkan tabel peer
          $("#peers-table tbody").empty();

          // Tambahkan setiap peer ke tabel
          result.peers.forEach((peer) => {
            // Format waktu koneksi
            const connectedTime = peer.connectedAt
              ? new Date(peer.connectedAt).toLocaleString("id-ID")
              : "-";

            const newRow = `
        <tr data-address="${peer}">
          <td>${peer}</td>
          <td>
            <div class="action-buttons">
              <button class="btn btn-small btn-delete" onclick="disconnectPeer('${peer}')">Putuskan</button>
            </div>
          </td>
        </tr>
      `;
            $("#peers-table tbody").append(newRow);
          });
        } catch (error) {
          console.error("Error loading peers:", error);
          showMessage("peer-response", "Gagal mengambil data peer", false);
        }
      }

      // Fungsi untuk memutuskan koneksi dengan peer
      async function disconnectPeer(peerAddress) {
        if (
          confirm("Apakah Anda yakin ingin memutuskan koneksi dengan peer ini?")
        ) {
          try {
            const encodedAddress = encodeURIComponent(peerAddress);
            const response = await fetch(
              `http://localhost:3000/peers/${encodedAddress}`,
              {
                method: "DELETE",
              }
            );

            if (!response.ok) {
              const result = await response.json();
              throw new Error(result.message || "Failed to disconnect peer");
            }

            showMessage("peer-response", "Berhasil memutuskan peer", true);

            // Refresh daftar peer
            await loadPeers();
          } catch (error) {
            showMessage(
              "peer-response",
              "Gagal memutuskan peer: " + error.message,
              false
            );
          }
        }
      }

      // Handler form tambah peer baru
      $("#add-peer-form").submit(async function (e) {
        e.preventDefault();

        const peerAddress = $("#peerAddress").val().trim();

        if (!peerAddress) {
          showMessage("peer-response", "Alamat peer tidak boleh kosong", false);
          return;
        }

        try {
          const response = await fetch("http://localhost:3000/peers", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ peerAddress }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to connect to peer");
          }

          showMessage("peer-response", "Berhasil terhubung ke peer baru", true);

          // Reset form
          $("#add-peer-form")[0].reset();

          // Refresh daftar peer
          await loadPeers();
        } catch (error) {
          showMessage(
            "peer-response",
            "Gagal menghubungkan ke peer: " + error.message,
            false
          );
        }
      });

      // Tambahkan ke fungsi yang memuat data saat halaman dimuat
      $(document).ready(function () {
        // Fungsi yang sudah ada...

        // Tambahkan fungsi untuk memuat peer
        loadPeers();
      });

      // Tambahkan refresh peer setiap 30 detik untuk memastikan status up-to-date
      setInterval(loadPeers, 1000);

      // Load existing data when page loads
      $(document).ready(async function () {
        try {
          // Fetch all elections
          const electionsResponse = await fetch(
            "http://localhost:3000/elections"
          );
          const electionsResult = await electionsResponse.json();

          if (!electionsResponse.ok) {
            throw new Error("Failed to fetch elections");
          }

          // Clear existing options and add new ones
          $("#electionId").empty();
          $("#elections-table tbody").empty();

          electionsResult.data.forEach((election) => {
            // Format dates for display
            const startDate = new Date(election.startDate);
            const endDate = new Date(election.endDate);
            const formattedStartDate = startDate.toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });
            const formattedEndDate = endDate.toLocaleDateString("id-ID", {
              day: "numeric",
              month: "long",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            });

            // Add to elections dropdown
            $("#electionId").append(
              `<option value="${election.id}">${election.name}</option>`
            );

            // Add to elections table
            const statusBadge = election.isActive
              ? '<span class="badge badge-success">Aktif</span>'
              : '<span class="badge badge-secondary">Tidak Aktif</span>';

            const newRow = `
      <tr data-id="${election.id}">
        <td>${election.name}</td>
        <td>${formattedStartDate}</td>
        <td>${formattedEndDate}</td>
        <td>${statusBadge}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-small btn-edit">Edit</button>
            <button class="btn btn-small btn-delete" onclick="deleteElection('${election.id}')">Hapus</button>
          </div>
        </td>
      </tr>
    `;
            $("#elections-table tbody").append(newRow);
          });

          // Fetch all candidates
          const candidatesResponse = await fetch(
            "http://localhost:3000/candidates"
          );
          const candidatesResult = await candidatesResponse.json();

          if (!candidatesResponse.ok) {
            throw new Error("Failed to fetch candidates");
          }

          $("#candidates-table tbody").empty();

          for (const candidate of candidatesResult.data) {
            try {
              const electionResponse = await fetch(
                `http://localhost:3000/elections/${candidate.electionId}`
              );
              const electionResult = await electionResponse.json();

              const electionName = electionResult.data.name;

              const newRow = `
        <tr data-id="${candidate.id}">
          <td>${candidate.mainName} (${candidate.mainInitials})<br><small>${
                candidate.mainFaculty
              }</small></td>
          <td>${candidate.deputyName} (${candidate.deputyInitials})<br><small>${
                candidate.deputyFaculty
              }</small></td>
          <td>${electionName}</td>  
          <td>
            <div class="action-buttons">
              <button class="btn btn-small btn-edit">Edit</button>
              <button class="btn btn-small btn-delete" onclick="deleteCandidate('${
                candidate.id
              }')">Hapus</button>
            </div>
          </td>
        </tr>
      `;
              $("#candidates-table tbody").append(newRow);
            } catch (error) {
              console.error("Error fetching election:", error);
            }
          }

          // Fetch all students
          const studentsResponse = await fetch("http://localhost:3000/auth");
          const studentsResult = await studentsResponse.json();

          if (!studentsResponse.ok) {
            throw new Error("Failed to fetch students");
          }

          $("#students-table tbody").empty();

          studentsResult.data.forEach((student) => {

            const newRow = `
      <tr data-id="${student.nim}">
        <td>${student.nim}</td>
        <td>${student.name}</td>
        <td>${student.faculty}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-small btn-edit">Edit</button>
            <button class="btn btn-small btn-delete" onclick="deleteStudent('${student.nim}')">Hapus</button>
          </div>
        </td>
      </tr>
    `;
            $("#students-table tbody").append(newRow);
          });
        } catch (error) {
          console.error("Error loading data:", error);
          showMessage("candidate-response", "Gagal mengambil data", false);
        }
      });

      // Delete functions
      async function deleteCandidate(id) {
        if (confirm("Apakah Anda yakin ingin menghapus kandidat ini?")) {
          try {
            const response = await fetch(
              `http://localhost:3000/candidates/${id}`,
              {
                method: "DELETE",
              }
            );

            if (!response.ok) {
              const result = await response.json();
              throw new Error(result.message || "Failed to delete candidate");
            }

            showMessage(
              "candidate-response",
              "Kandidat berhasil dihapus",
              true
            );
            $(`#candidates-table tr[data-id="${id}"]`).remove();
          } catch (error) {
            showMessage(
              "candidate-response",
              "Gagal menghapus kandidat",
              false
            );
          }
        }
      }

      async function deleteElection(id) {
        if (
          confirm(
            "Apakah Anda yakin ingin menghapus pemilihan ini? Semua kandidat terkait juga akan dihapus."
          )
        ) {
          try {
            const response = await fetch(
              `http://localhost:3000/elections/${id}`,
              {
                method: "DELETE",
              }
            );

            if (!response.ok) {
              const result = await response.json();
              throw new Error(result.message || "Failed to delete election");
            }

            showMessage(
              "election-response",
              "Pemilihan berhasil dihapus",
              true
            );
            $(`#elections-table tr[data-id="${id}"]`).remove();
            $(`#electionId option[value="${id}"]`).remove();

            // Refresh candidates table as some may have been deleted
            await refreshCandidatesList();
          } catch (error) {
            showMessage(
              "election-response",
              "Gagal menghapus pemilihan",
              false
            );
          }
        }
      }

      async function deleteStudent(id) {
        if (confirm("Apakah Anda yakin ingin menghapus mahasiswa ini?")) {
          try {
            const response = await fetch(`http://localhost:3000/auth/${id}`, {
              method: "DELETE",
            });

            if (!response.ok) {
              const result = await response.json();
              throw new Error(result.message || "Failed to delete student");
            }

            showMessage("student-response", "Mahasiswa berhasil dihapus", true);
            $(`#students-table tr[data-id="${id}"]`).remove();
          } catch (error) {
            showMessage("student-response", "Gagal menghapus mahasiswa", false);
          }
        }
      }

      // Edit functionality for Candidates
      $(document).on("click", "#candidates-tab .btn-edit", async function () {
        const row = $(this).closest("tr");
        const candidateId = row.attr("data-id");

        try {
          // Get candidate data from the server
          const response = await fetch(
            `http://localhost:3000/candidates/${candidateId}`
          );
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to fetch candidate data");
          }

          const candidate = result.data;

          // Populate form with existing data
          $("#mainName").val(candidate.mainName);
          $("#mainInitials").val(candidate.mainInitials);
          $("#mainFaculty").val(candidate.mainFaculty);
          $("#deputyName").val(candidate.deputyName);
          $("#deputyInitials").val(candidate.deputyInitials);
          $("#deputyFaculty").val(candidate.deputyFaculty);
          $("#vision").val(candidate.vision);
          $("#electionId").val(candidate.electionId);

          // Change form button to update mode
          const submitBtn = $('#add-candidate-form button[type="submit"]');
          submitBtn.text("Update Kandidat");
          submitBtn.attr("data-id", candidateId);
          submitBtn.attr("data-mode", "edit");

          // Scroll to form
          $("html, body").animate(
            {
              scrollTop: $("#add-candidate-form").offset().top - 100,
            },
            500
          );
        } catch (error) {
          showMessage(
            "candidate-response",
            "Gagal mendapatkan data kandidat",
            false
          );
        }
      });

      // Fixed candidate form submission - handles both create and edit in one handler
      $("#add-candidate-form").submit(async function (e) {
        e.preventDefault();

        const submitBtn = $(this).find('button[type="submit"]');
        const mode = submitBtn.attr("data-mode") || "create";
        const candidateId = submitBtn.attr("data-id");

        // Collect form data
        const candidateData = {
          mainName: $("#mainName").val(),
          mainInitials: $("#mainInitials").val(),
          mainFaculty: $("#mainFaculty").val(),
          deputyName: $("#deputyName").val(),
          deputyInitials: $("#deputyInitials").val(),
          deputyFaculty: $("#deputyFaculty").val(),
          vision: $("#vision").val(),
          electionId: $("#electionId").val(),
        };

        try {
          let response, result;

          // Handle based on mode
          if (mode === "edit" && candidateId) {
            // Update existing candidate
            response = await fetch(
              `http://localhost:3000/candidates/${candidateId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(candidateData),
              }
            );

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to update candidate");
            }

            showMessage(
              "candidate-response",
              "Kandidat berhasil diupdate",
              true
            );
          } else {
            // Create new candidate
            response = await fetch("http://localhost:3000/candidates", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(candidateData),
            });

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to create candidate");
            }

            showMessage("candidate-response", "Kandidat berhasil dibuat", true);
          }

          // Reset form and button state
          $("#add-candidate-form")[0].reset();
          submitBtn.text("Tambah Kandidat");
          submitBtn.removeAttr("data-id");
          submitBtn.removeAttr("data-mode");

          // Refresh the candidates list
          await refreshCandidatesList();
        } catch (error) {
          showMessage("candidate-response", error.message, false);
        }
      });

      // Helper function to refresh candidates list
      async function refreshCandidatesList() {
        try {
          const response = await fetch("http://localhost:3000/candidates");
          const result = await response.json();

          if (!response.ok) {
            throw new Error("Failed to fetch candidates");
          }

          $("#candidates-table tbody").empty();

          for (const candidate of result.data) {
            try {
              const electionResponse = await fetch(
                `http://localhost:3000/elections/${candidate.electionId}`
              );
              const electionResult = await electionResponse.json();
              await addCandidateToTable(candidate, electionResult.data.name);
            } catch (error) {
              // If election not found, just show candidate with unknown election
              await addCandidateToTable(candidate, "Unknown");
            }
          }
        } catch (error) {
          console.error("Error refreshing candidates:", error);
        }
      }

      // Helper function to add a candidate to the table
      async function addCandidateToTable(candidate, electionName) {
        const newRow = `
  <tr data-id="${candidate.id}">
    <td>${candidate.mainName} (${candidate.mainInitials})<br><small>${
          candidate.mainFaculty
        }</small></td>
    <td>${candidate.deputyName} (${candidate.deputyInitials})<br><small>${
          candidate.deputyFaculty
        }</small></td>
    <td>${electionName || $("#electionId option:selected").text()}</td>
    <td>${candidate.voteCount || 0}</td>
    <td>
      <div class="action-buttons">
        <button class="btn btn-small btn-edit">Edit</button>
        <button class="btn btn-small btn-delete" onclick="deleteCandidate('${
          candidate.id
        }')">Hapus</button>
      </div>
    </td>
  </tr>
`;
        $("#candidates-table tbody").append(newRow);
      }

      // Edit functionality for Elections
      $(document).on("click", "#elections-tab .btn-edit", async function () {
        const row = $(this).closest("tr");
        const electionId = row.attr("data-id");

        try {
          // Get election data from the server
          const response = await fetch(
            `http://localhost:3000/elections/${electionId}`
          );
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to fetch election data");
          }

          const election = result.data;

          // Format dates for form inputs (YYYY-MM-DDThh:mm)
          const startDate = new Date(election.startDate);
          const endDate = new Date(election.endDate);

          const formattedStartDate = startDate.toISOString().slice(0, 16);
          const formattedEndDate = endDate.toISOString().slice(0, 16);

          // Populate form with existing data
          $("#electionName").val(election.name);
          $("#startDate").val(formattedStartDate);
          $("#endDate").val(formattedEndDate);
          $("#isActive").val(election.isActive.toString());

          // Change form button to update mode
          const submitBtn = $('#add-election-form button[type="submit"]');
          submitBtn.text("Update Pemilihan");
          submitBtn.attr("data-id", electionId);
          submitBtn.attr("data-mode", "edit");

          // Scroll to form
          $("html, body").animate(
            {
              scrollTop: $("#add-election-form").offset().top - 100,
            },
            500
          );
        } catch (error) {
          showMessage(
            "election-response",
            "Gagal mendapatkan data pemilihan",
            false
          );
        }
      });

      // Fixed election form submission - handles both create and edit in one handler
      $("#add-election-form").submit(async function (e) {
        e.preventDefault();

        const submitBtn = $(this).find('button[type="submit"]');
        const mode = submitBtn.attr("data-mode") || "create";
        const electionId = submitBtn.attr("data-id");

        // Format dates properly
        const startDateTime = new Date($("#startDate").val()).toISOString();
        const endDateTime = new Date($("#endDate").val()).toISOString();

        // Collect form data
        const electionData = {
          name: $("#electionName").val(),
          startDate: startDateTime,
          endDate: endDateTime,
          isActive: $("#isActive").val() === "true",
        };

        try {
          let response, result;

          // Handle based on mode
          if (mode === "edit" && electionId) {
            // Update existing election
            response = await fetch(
              `http://localhost:3000/elections/${electionId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(electionData),
              }
            );

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to update election");
            }

            showMessage(
              "election-response",
              "Pemilihan berhasil diupdate",
              true
            );
          } else {
            // Create new election
            response = await fetch("http://localhost:3000/elections", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(electionData),
            });

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to create election");
            }

            showMessage("election-response", "Election berhasil dibuat", true);

            // Add to dropdown
            $("#electionId").append(
              `<option value="${result.data.id}">${result.data.name}</option>`
            );
          }

          // Reset form and button state
          $("#add-election-form")[0].reset();
          submitBtn.text("Tambah Pemilihan");
          submitBtn.removeAttr("data-id");
          submitBtn.removeAttr("data-mode");

          // Refresh the elections list
          await refreshElectionsList();
        } catch (error) {
          showMessage("election-response", error.message, false);
        }
      });

      // Helper function to refresh elections list
      async function refreshElectionsList() {
        try {
          const response = await fetch("http://localhost:3000/elections");
          const result = await response.json();

          if (!response.ok) {
            throw new Error("Failed to fetch elections");
          }

          // Clear existing data
          $("#electionId").empty();
          $("#elections-table tbody").empty();

          // Add each election to table and dropdown
          for (const election of result.data) {
            await addElectionToTable(election);
            $("#electionId").append(
              `<option value="${election.id}">${election.name}</option>`
            );
          }
        } catch (error) {
          console.error("Error refreshing elections:", error);
        }
      }

      // Helper function to add an election to the table
      async function addElectionToTable(election) {
        // Format dates for display
        const startDate = new Date(election.startDate);
        const endDate = new Date(election.endDate);
        const formattedStartDate = startDate.toLocaleDateString("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });
        const formattedEndDate = endDate.toLocaleDateString("id-ID", {
          day: "numeric",
          month: "long",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        });

        // Create status badge
        const statusBadge = election.isActive
          ? '<span class="badge badge-success">Aktif</span>'
          : '<span class="badge badge-secondary">Tidak Aktif</span>';

        // Create row
        const newRow = `
  <tr data-id="${election.id}">
    <td>${election.name}</td>
    <td>${formattedStartDate}</td>
    <td>${formattedEndDate}</td>
    <td>${statusBadge}</td>
    <td>
      <div class="action-buttons">
        <button class="btn btn-small btn-edit">Edit</button>
        <button class="btn btn-small btn-delete" onclick="deleteElection('${election.id}')">Hapus</button>
      </div>
    </td>
  </tr>
`;
        $("#elections-table tbody").append(newRow);
      }

      // Edit functionality for Students
      $(document).on("click", "#students-tab .btn-edit", async function () {
        const row = $(this).closest("tr");
        const nim = row.attr("data-id");

        try {
          // Get student data from the server
          const response = await fetch(`http://localhost:3000/auth/${nim}`);
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.message || "Failed to fetch student data");
          }

          const student = result.data;

          // Populate form with existing data
          $("#nim").val(student.nim);
          $("#nama").val(student.name);
          $("#faculty").val(student.faculty);
          // Note: Not setting password field as typically you wouldn't display existing passwords

          // Change form button to update mode
          const submitBtn = $('#add-student-form button[type="submit"]');
          submitBtn.text("Update Mahasiswa");
          submitBtn.attr("data-id", student.nim);
          submitBtn.attr("data-mode", "edit");

          // Add note about password
          if (!$("#password-note").length) {
            $("#password").after(
              '<p id="password-note" style="color:#666;font-size:0.8em;margin-top:5px;">Biarkan kosong jika tidak ingin mengubah password</p>'
            );
          }

          // Scroll to form
          $("html, body").animate(
            {
              scrollTop: $("#add-student-form").offset().top - 100,
            },
            500
          );
        } catch (error) {
          showMessage(
            "student-response",
            "Gagal mendapatkan data mahasiswa",
            false
          );
        }
      });

      // Fixed student form submission - handles both create and edit in one handler
      $("#add-student-form").submit(async function (e) {
        e.preventDefault();

        const submitBtn = $(this).find('button[type="submit"]');
        const mode = submitBtn.attr("data-mode") || "create";
        const origNim = submitBtn.attr("data-id");

        // Collect form data
        const studentData = {
          nim: $("#nim").val(),
          name: $("#nama").val(),
          faculty: $("#faculty").val(),
        };

        // Only include password if it's not empty
        if ($("#password").val().trim() !== "") {
          studentData.password = $("#password").val();
        }

        try {
          let response, result;

          // Handle based on mode
          if (mode === "edit" && origNim) {
            // Update existing student
            response = await fetch(`http://localhost:3000/auth/${origNim}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentData),
            });

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to update student");
            }

            showMessage(
              "student-response",
              "Mahasiswa berhasil diupdate",
              true
            );
            $("#password-note").remove();
          } else {
            // Add new student - need to ensure password is provided
            if (!studentData.password) {
              throw new Error(
                "Password diperlukan untuk membuat mahasiswa baru"
              );
            }

            response = await fetch("http://localhost:3000/auth", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(studentData),
            });

            result = await response.json();

            if (!response.ok) {
              throw new Error(result.message || "Failed to create student");
            }

            showMessage("student-response", "Mahasiswa berhasil dibuat", true);
          }

          // Reset form and button state
          $("#add-student-form")[0].reset();
          submitBtn.text("Tambah Mahasiswa");
          submitBtn.removeAttr("data-id");
          submitBtn.removeAttr("data-mode");

          // Refresh students list
          await refreshStudentsList();
        } catch (error) {
          showMessage("student-response", error.message, false);
        }
      });

      // Helper function to refresh students list
      async function refreshStudentsList() {
        try {
          const response = await fetch("http://localhost:3000/auth");
          const result = await response.json();

          if (!response.ok) {
            throw new Error("Failed to fetch students");
          }

          $("#students-table tbody").empty();

          for (const student of result.data) {
            await addStudentToTable(student);
          }
        } catch (error) {
          console.error("Error refreshing students:", error);
        }
      }

      // Helper function to add a student to the table
      async function addStudentToTable(student) {

        const newRow = `
  <tr data-id="${student.nim}">
    <td>${student.nim}</td>
    <td>${student.name}</td>
    <td>${student.faculty}</td>
    <td>
      <div class="action-buttons">
        <button class="btn btn-small btn-edit">Edit</button>
        <button class="btn btn-small btn-delete" onclick="deleteStudent('${student.nim}')">Hapus</button>
      </div>
    </td>
  </tr>
`;
        $("#students-table tbody").append(newRow);
      }
    </script>
  </body>
</html>
